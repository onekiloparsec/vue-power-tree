(function(u,o){typeof exports=="object"&&typeof module!="undefined"?o(exports,require("vue")):typeof define=="function"&&define.amd?define(["exports","vue"],o):(u=typeof globalThis!="undefined"?globalThis:u||self,o(u.VuePowerTable={},u.Vue))})(this,function(u,o){"use strict";var N={name:"power-tree",emits:["input","select","beforedrop","drop","toggle","nodeclick","nodedblclick","nodecontextmenu","externaldragover","externaldrop"],props:{value:{type:Array,default:()=>[]},edgeSize:{type:Number,default:3},showBranches:{type:Boolean,default:!1},level:{type:Number,default:0},parentInd:{type:Number},allowMultiselect:{type:Boolean,default:!0},allowToggleBranch:{type:Boolean,default:!0},multiselectKey:{type:[String,Array],default:function(){return["ctrlKey","metaKey"]},validator:function(e){let t=["ctrlKey","metaKey","altKey"],s=Array.isArray(e)?e:[e];return s=s.filter(i=>t.indexOf(i)!==-1),!!s.length}},scrollAreaHeight:{type:Number,default:70},maxScrollSpeed:{type:Number,default:20}},data(){return{rootCursorPosition:null,scrollIntervalId:0,scrollSpeed:0,lastSelectedNode:null,mouseIsDown:!1,isDragging:!1,lastMousePos:{x:0,y:0},preventDrag:!1,currentValue:this.value}},mounted(){this.isRoot&&document.addEventListener("mouseup",this.onDocumentMouseupHandler)},beforeDestroy(){document.removeEventListener("mouseup",this.onDocumentMouseupHandler)},watch:{value:function(e){this.currentValue=e}},computed:{cursorPosition(){return this.isRoot?this.rootCursorPosition:this.getParent().cursorPosition},depth(){return this.gaps.length},nodes(){if(this.isRoot){const e=this.copy(this.currentValue);return this.getNodes(e)}return this.getParent().nodes[this.parentInd].children},gaps(){const e=[];let t=this.level-1;for(this.showBranches||t++;t-- >0;)e.push(t);return e},isRoot(){return!this.level},selectionSize(){return this.getSelected().length},dragSize(){return this.getDraggable().length}},methods:{setCursorPosition(e){if(this.isRoot){this.rootCursorPosition=e;return}this.getParent().setCursorPosition(e)},getNodes(e,t=[],s=!0){return e.map((i,l)=>{const n=t.concat(l);return this.getNode(n,i,e,s)})},getNode(e,t=null,s=null,i=null){const l=e.slice(-1)[0];if(s=s||this.getNodeSiblings(this.currentValue,e),t=t||s&&s[l]||null,i==null&&(i=this.isVisible(e)),!t)return null;const n=t.isExpanded===void 0?!0:!!t.isExpanded,c=t.isDraggable===void 0?!0:!!t.isDraggable,r=t.isSelectable===void 0?!0:!!t.isSelectable;return{title:t.title,isLeaf:!!t.isLeaf,children:t.children?this.getNodes(t.children,e,n):[],isSelected:!!t.isSelected,isExpanded:n,isVisible:i,isDraggable:c,isSelectable:r,data:t.data!==void 0?t.data:{},path:e,pathStr:JSON.stringify(e),level:e.length,ind:l,isFirstChild:l===0,isLastChild:l===s.length-1}},isVisible(e){if(e.length<2)return!0;let t=this.currentValue;for(let s=0;s<e.length-1;s++){let i=e[s],l=t[i];if(!(l.isExpanded===void 0?!0:!!l.isExpanded))return!1;t=l.children}return!0},emitInput(e){this.currentValue=e,this.getRoot().$emit("input",e)},emitSelect(e,t){this.getRoot().$emit("select",e,t)},emitBeforeDrop(e,t,s){this.getRoot().$emit("beforedrop",e,t,s)},emitDrop(e,t,s){this.getRoot().$emit("drop",e,t,s)},emitToggle(e,t){this.getRoot().$emit("toggle",e,t)},emitNodeClick(e,t){this.getRoot().$emit("nodeclick",e,t)},emitNodeDblclick(e,t){this.getRoot().$emit("nodedblclick",e,t)},emitNodeContextmenu(e,t){this.getRoot().$emit("nodecontextmenu",e,t)},onExternalDragoverHandler(e,t){t.preventDefault();const s=this.getRoot(),i=s.getCursorPositionFromCoords(t.clientX,t.clientY);s.setCursorPosition(i),s.$emit("externaldragover",i,t)},onExternalDropHandler(e,t){const s=this.getRoot(),i=s.getCursorPositionFromCoords(t.clientX,t.clientY);s.$emit("externaldrop",i,t),this.setCursorPosition(null)},select(e,t=!1,s=null){const i=Array.isArray(this.multiselectKey)?this.multiselectKey:[this.multiselectKey];t=(s&&!!i.find(h=>s[h])||t)&&this.allowMultiselect;const n=this.getNode(e);if(!n)return null;const c=this.copy(this.currentValue),r=this.allowMultiselect&&s&&s.shiftKey&&this.lastSelectedNode,d=[];let a=!1;return this.traverse((h,g)=>{r?((h.pathStr===n.pathStr||h.pathStr===this.lastSelectedNode.pathStr)&&(g.isSelected=h.isSelectable,a=!a),a&&(g.isSelected=h.isSelectable)):h.pathStr===n.pathStr?g.isSelected=h.isSelectable:t||g.isSelected&&(g.isSelected=!1),g.isSelected&&d.push(h)},c),this.lastSelectedNode=n,this.emitInput(c),this.emitSelect(d,s),n},onMousemoveHandler(e){if(!this.isRoot){this.getRoot().onMousemoveHandler(e);return}if(this.preventDrag)return;const t=this.isDragging,s=this.isDragging||this.mouseIsDown&&(this.lastMousePos.x!==e.clientX||this.lastMousePos.y!==e.clientY),i=t===!1&&s===!0;if(this.lastMousePos={x:e.clientX,y:e.clientY},!s)return;const l=this.getRoot().$el,n=l.getBoundingClientRect(),c=this.$refs.dragInfo,r=e.clientY-n.top+l.scrollTop-(c.style.marginBottom|0),d=e.clientX-n.left;c.style.top=r+"px",c.style.left=d+"px";const a=this.getCursorPositionFromCoords(e.clientX,e.clientY),h=a.node,g=a.placement;if(i&&!h.isSelected&&this.select(h.path,!1,e),!this.getDraggable().length){this.preventDrag=!0;return}this.isDragging=s,this.setCursorPosition({node:h,placement:g});const p=n.bottom-this.scrollAreaHeight,f=(e.clientY-p)/(n.bottom-p),m=n.top+this.scrollAreaHeight,S=(m-e.clientY)/(m-n.top);f>0?this.startScroll(f):S>0?this.startScroll(-S):this.stopScroll()},getCursorPositionFromCoords(e,t){const s=document.elementFromPoint(e,t),i=s.getAttribute("path")?s:this.getClosetElementWithPath(s);let l,n;if(i){if(!i)return;l=this.getNode(JSON.parse(i.getAttribute("path")));const c=i.offsetHeight,r=this.edgeSize,d=t-i.getBoundingClientRect().top;l.isLeaf?n=d>=c/2?"after":"before":d<=r?n="before":d>=c-r?n="after":n="inside"}else{const r=this.getRoot().$el.getBoundingClientRect();t>r.top+r.height/2?(n="after",l=this.getLastNode()):(n="before",l=this.getFirstNode())}return{node:l,placement:n}},getClosetElementWithPath(e){return e?e.getAttribute("path")?e:this.getClosetElementWithPath(e.parentElement):null},onMouseleaveHandler(e){if(!this.isRoot||!this.isDragging)return;const s=this.getRoot().$el.getBoundingClientRect();e.clientY>=s.bottom?this.setCursorPosition({node:this.nodes.slice(-1)[0],placement:"after"}):e.clientY<s.top&&this.setCursorPosition({node:this.getFirstNode(),placement:"before"})},getNodeEl(e){this.getRoot().$el.querySelector(`[path="${JSON.stringify(e)}"]`)},getLastNode(){let e=null;return this.traverse(t=>{e=t}),e},getFirstNode(){return this.getNode([0])},getNextNode(e,t=null){let s=null;return this.traverse(i=>{if(!(this.comparePaths(i.path,e)<1)&&(!t||t(i)))return s=i,!1}),s},getPrevNode(e,t){let s=[];this.traverse(l=>{if(this.comparePaths(l.path,e)>=0)return!1;s.push(l)});let i=s.length;for(;i--;){const l=s[i];if(!t||t(l))return l}return null},comparePaths(e,t){for(let s=0;s<e.length;s++){if(t[s]===void 0||e[s]>t[s])return 1;if(e[s]<t[s])return-1}return t[e.length]===void 0?0:-1},onNodeMousedownHandler(e,t){if(e.button===0){if(!this.isRoot){this.getRoot().onNodeMousedownHandler(e,t);return}this.mouseIsDown=!0}},startScroll(e){const t=this.getRoot().$el;this.scrollSpeed!==e&&(this.scrollIntervalId&&this.stopScroll(),this.scrollSpeed=e,this.scrollIntervalId=setInterval(()=>{t.scrollTop+=this.maxScrollSpeed*e},20))},stopScroll(){clearInterval(this.scrollIntervalId),this.scrollIntervalId=0,this.scrollSpeed=0},onDocumentMouseupHandler(e){this.isDragging&&this.onNodeMouseupHandler(e)},onNodeMouseupHandler(e,t=null){if(e.button!==0)return;if(!this.isRoot){this.getRoot().onNodeMouseupHandler(e,t);return}if(this.mouseIsDown=!1,!this.isDragging&&t&&!this.preventDrag&&this.select(t.path,!1,e),this.preventDrag=!1,!this.cursorPosition){this.stopDrag();return}const s=this.getDraggable();for(let r of s){if(r.pathStr===this.cursorPosition.node.pathStr){this.stopDrag();return}if(this.checkNodeIsParent(r,this.cursorPosition.node)){this.stopDrag();return}}const i=this.copy(this.currentValue),l=[];for(let r of s){const a=this.getNodeSiblings(i,r.path)[r.ind];l.push(a)}let n=!1;if(this.emitBeforeDrop(s,this.cursorPosition,()=>n=!0),n){this.stopDrag();return}const c=[];for(let r of l)c.push(this.copy(r)),r._markToDelete=!0;this.insertModels(this.cursorPosition,c,i),this.traverseModels((r,d,a)=>{!r._markToDelete||d.splice(a,1)},i),this.lastSelectedNode=null,this.emitInput(i),this.emitDrop(s,this.cursorPosition,e),this.stopDrag()},onToggleHandler(e,t){!this.allowToggleBranch||(this.updateNode(t.path,{isExpanded:!t.isExpanded}),this.emitToggle(t,e),e.stopPropagation())},stopDrag(){this.isDragging=!1,this.mouseIsDown=!1,this.setCursorPosition(null),this.stopScroll()},getParent(){return this.$parent},getRoot(){return this.isRoot?this:this.getParent().getRoot()},getNodeSiblings(e,t){return t.length===1?e:this.getNodeSiblings(e[t[0]].children,t.slice(1))},updateNode(e,t){if(!this.isRoot){this.getParent().updateNode(e,t);return}const s=JSON.stringify(e),i=this.copy(this.currentValue);this.traverse((l,n)=>{l.pathStr===s&&Object.assign(n,t)},i),this.emitInput(i)},getSelected(){const e=[];return this.traverse(t=>{t.isSelected&&e.push(t)}),e},getDraggable(){const e=[];return this.traverse(t=>{t.isSelected&&t.isDraggable&&e.push(t)}),e},traverse(e,t=null,s=[]){t||(t=this.currentValue);let i=!1;const l=[];for(let n=0;n<t.length;n++){const c=t[n],r=s.concat(n),d=this.getNode(r,c,t);if(i=e(d,c,t)===!1,l.push(d),i||c.children&&(i=this.traverse(e,c.children,r)===!1,i))break}return i?!1:l},traverseModels(e,t){let s=t.length;for(;s--;){const i=t[s];i.children&&this.traverseModels(e,i.children),e(i,t,s)}return t},remove(e){const t=e.map(i=>JSON.stringify(i)),s=this.copy(this.currentValue);this.traverse((i,l,n)=>{for(const c of t)i.pathStr===c&&(l._markToDelete=!0)},s),this.traverseModels((i,l,n)=>{!i._markToDelete||l.splice(n,1)},s),this.emitInput(s)},insertModels(e,t,s){const i=e.node,l=this.getNodeSiblings(s,i.path),n=l[i.ind];if(e.placement==="inside")n.children=n.children||[],n.children.unshift(...t);else{const c=e.placement==="before"?i.ind:i.ind+1;l.splice(c,0,...t)}},insert(e,t){const s=Array.isArray(t)?t:[t],i=this.copy(this.currentValue);this.insertModels(e,s,i),this.emitInput(i)},checkNodeIsParent(e,t){const s=t.path;return JSON.stringify(s.slice(0,e.path.length))===e.pathStr},copy(e){return JSON.parse(JSON.stringify(e))}}},y=(e,t)=>{const s=e.__vccOpts||e;for(const[i,l]of t)s[i]=l;return s};const D={ref:"nodes",class:"vue-power-tree-nodes-list"},w=["onMousedown","onMouseup","onContextmenu","onDblclick","onClick","onDragover","onDrop","path"],b={class:"vue-power-tree-gap"},P={key:0,class:"vue-power-tree-branch"},C={key:0},k={key:1},E={class:"vue-power-tree-title"},B=["onClick"],I={class:"vue-power-tree-sidebar"},R={slot:"title","slot-scope":"{ node }"},$={slot:"toggle","slot-scope":"{ node }"},V={slot:"sidebar","slot-scope":"{ node }"},H={slot:"empty-node","slot-scope":"{ node }"},T={key:0,ref:"dragInfo",class:"vue-power-tree-drag-info"};function M(e,t,s,i,l,n){const c=o.resolveComponent("power-tree",!0);return o.openBlock(),o.createElementBlock("div",{class:o.normalizeClass(["vue-power-tree",{"vue-power-tree-root":e.isRoot}]),onMousemove:t[3]||(t[3]=(...r)=>e.onMousemoveHandler&&e.onMousemoveHandler(...r)),onMouseleave:t[4]||(t[4]=(...r)=>e.onMouseleaveHandler&&e.onMouseleaveHandler(...r)),onDragend:t[5]||(t[5]=r=>e.onDragendHandler(null,r))},[o.createElementVNode("div",D,[(o.openBlock(!0),o.createElementBlock(o.Fragment,null,o.renderList(e.nodes,(r,d)=>(o.openBlock(),o.createElementBlock("div",{class:o.normalizeClass(["vue-power-tree-node",{"vue-power-tree-selected":r.isSelected}])},[o.createElementVNode("div",{class:"vue-power-tree-cursor vue-power-tree-cursor_before",onDragover:t[0]||(t[0]=o.withModifiers(()=>{},["prevent"])),style:o.normalizeStyle({visibility:e.cursorPosition&&e.cursorPosition.node.pathStr===r.pathStr&&e.cursorPosition.placement==="before"?"visible":"hidden","--depth":e.depth})},null,36),o.createElementVNode("div",{class:o.normalizeClass(["vue-power-tree-node-item",{"vue-power-tree-cursor-hover":e.cursorPosition&&e.cursorPosition.node.pathStr===r.pathStr,"vue-power-tree-cursor-inside":e.cursorPosition&&e.cursorPosition.placement==="inside"&&e.cursorPosition.node.pathStr===r.pathStr,"vue-power-tree-node-is-leaf":r.isLeaf,"vue-power-tree-node-is-folder":!r.isLeaf}]),onMousedown:a=>e.onNodeMousedownHandler(a,r),onMouseup:a=>e.onNodeMouseupHandler(a,r),onContextmenu:a=>e.emitNodeContextmenu(r,a),onDblclick:a=>e.emitNodeDblclick(r,a),onClick:a=>e.emitNodeClick(r,a),onDragover:a=>e.onExternalDragoverHandler(r,a),onDrop:a=>e.onExternalDropHandler(r,a),path:r.pathStr},[(o.openBlock(!0),o.createElementBlock(o.Fragment,null,o.renderList(e.gaps,a=>(o.openBlock(),o.createElementBlock("div",b))),256)),e.level&&e.showBranches?(o.openBlock(),o.createElementBlock("div",P,[o.renderSlot(e.$slots,"branch",{node:r},()=>[r.isLastChild?o.createCommentVNode("",!0):(o.openBlock(),o.createElementBlock("span",C,o.toDisplayString(String.fromCharCode(9500))+o.toDisplayString(String.fromCharCode(9472))+"\xA0 ",1)),r.isLastChild?(o.openBlock(),o.createElementBlock("span",k,o.toDisplayString(String.fromCharCode(9492))+o.toDisplayString(String.fromCharCode(9472))+"\xA0 ",1)):o.createCommentVNode("",!0)])])):o.createCommentVNode("",!0),o.createElementVNode("div",E,[r.isLeaf?o.createCommentVNode("",!0):(o.openBlock(),o.createElementBlock("span",{key:0,class:"vue-power-tree-toggle",onClick:a=>e.onToggleHandler(a,r)},[o.renderSlot(e.$slots,"toggle",{node:r},()=>[o.createElementVNode("span",null,o.toDisplayString(r.isLeaf?"":r.isExpanded?"-":"+"),1)])],8,B)),o.renderSlot(e.$slots,"title",{node:r},()=>[o.createTextVNode(o.toDisplayString(r.title),1)]),!r.isLeaf&&r.children.length==0&&r.isExpanded?o.renderSlot(e.$slots,"empty-node",{key:1,node:r}):o.createCommentVNode("",!0)]),o.createElementVNode("div",I,[o.renderSlot(e.$slots,"sidebar",{node:r})])],42,w),r.children&&r.children.length&&r.isExpanded?(o.openBlock(),o.createBlock(c,{key:0,value:r.children,level:r.level,parentInd:d,allowMultiselect:e.allowMultiselect,allowToggleBranch:e.allowToggleBranch,edgeSize:e.edgeSize,showBranches:e.showBranches,onDragover:t[1]||(t[1]=o.withModifiers(()=>{},["prevent"]))},{default:o.withCtx(()=>[o.createElementVNode("template",R,[o.renderSlot(e.$slots,"title",{node:r},()=>[o.createTextVNode(o.toDisplayString(r.title),1)])]),o.createElementVNode("template",$,[o.renderSlot(e.$slots,"toggle",{node:r},()=>[o.createElementVNode("span",null,o.toDisplayString(r.isLeaf?"":r.isExpanded?"-":"+"),1)])]),o.createElementVNode("template",V,[o.renderSlot(e.$slots,"sidebar",{node:r})]),o.createElementVNode("template",H,[!r.isLeaf&&r.children.length==0&&r.isExpanded?o.renderSlot(e.$slots,"empty-node",{key:0,node:r}):o.createCommentVNode("",!0)])]),_:2},1032,["value","level","parentInd","allowMultiselect","allowToggleBranch","edgeSize","showBranches"])):o.createCommentVNode("",!0),o.createElementVNode("div",{class:"vue-power-tree-cursor vue-power-tree-cursor_after",onDragover:t[2]||(t[2]=o.withModifiers(()=>{},["prevent"])),style:o.normalizeStyle({visibility:e.cursorPosition&&e.cursorPosition.node.pathStr===r.pathStr&&e.cursorPosition.placement==="after"?"visible":"hidden","--depth":e.depth})},null,36)],2))),256)),e.isRoot?o.withDirectives((o.openBlock(),o.createElementBlock("div",T,[o.renderSlot(e.$slots,"draginfo",{},()=>[o.createTextVNode(" Items: "+o.toDisplayString(e.selectionSize),1)])],512)),[[o.vShow,e.isDragging]]):o.createCommentVNode("",!0)],512)],34)}var L=y(N,[["render",M]]),v="";u.PowerTree=L,Object.defineProperty(u,"__esModule",{value:!0}),u[Symbol.toStringTag]="Module"});
