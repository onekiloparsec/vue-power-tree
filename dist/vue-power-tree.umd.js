(function(g,s){typeof exports=="object"&&typeof module<"u"?s(exports,require("vue")):typeof define=="function"&&define.amd?define(["exports","vue"],s):(g=typeof globalThis<"u"?globalThis:g||self,s(g.VuePowerTree={},g.Vue))})(this,function(g,s){"use strict";const D={name:"power-tree",emits:["update:modelValue","select","beforedrop","drop","toggle","nodeclick","nodedblclick","nodecontextmenu","externaldragover","externaldrop"],props:{modelValue:{type:Array,default:()=>[]},edgeSize:{type:Number,default:3},showBranches:{type:Boolean,default:!1},level:{type:Number,default:0},parentInd:{type:Number},allowMultiselect:{type:Boolean,default:!0},allowToggleBranch:{type:Boolean,default:!0},scrollAreaHeight:{type:Number,default:70},maxScrollSpeed:{type:Number,default:20}},data(){return{rootCursorPosition:null,scrollIntervalId:0,scrollSpeed:0,lastSelectedNode:null,mouseIsDown:!1,isDragging:!1,lastMousePos:{x:0,y:0},preventDrag:!1,currentValue:this.modelValue}},mounted(){this.isRoot&&document.addEventListener("mouseup",this.onDocumentMouseupHandler)},beforeDestroy(){document.removeEventListener("mouseup",this.onDocumentMouseupHandler)},watch:{modelValue:function(e){this.currentValue=this.copy(e)}},computed:{cursorPosition(){return this.isRoot?this.rootCursorPosition:this.getParent().cursorPosition},depth(){return this.gaps.length},nodes(){if(this.isRoot){const e=this.copy(this.currentValue);return this.getNodes(e)}return this.getParent().nodes[this.parentInd].children},gaps(){const e=[];let t=this.level-1;for(this.showBranches||t++;t-- >0;)e.push(t);return e},isRoot(){return!this.level},selectionSize(){return this.getSelected().length},dragSize(){return this.getDraggable().length}},methods:{setCursorPosition(e){if(this.isRoot){this.rootCursorPosition=e;return}this.getParent().setCursorPosition(e)},getNodes(e,t=[],o=!0){return e.map((r,n)=>{const l=t.concat(n);return this.getNode(l,r,e,o)})},getNode(e,t=null,o=null,r=null){const n=e.slice(-1)[0];if(o=o||this.getNodeSiblings(this.currentValue,e),t=t||o&&o[n]||null,r==null&&(r=this.isVisible(e)),!t)return null;const l=t.isExpanded===void 0?!0:!!t.isExpanded,c=t.isDraggable===void 0?!0:!!t.isDraggable,i=t.isSelectable===void 0?!0:!!t.isSelectable;return{title:t.title,isLeaf:!!t.isLeaf,children:t.children?this.getNodes(t.children,e,l):[],isSelected:!!t.isSelected,isExpanded:l,isVisible:r,isDraggable:c,isSelectable:i,data:t.data!==void 0?t.data:{},path:e,pathStr:JSON.stringify(e),level:e.length,ind:n,isFirstChild:n===0,isLastChild:n===o.length-1}},isVisible(e){if(e.length<2)return!0;let t=this.currentValue;for(let o=0;o<e.length-1;o++){let r=e[o],n=t[r];if(!(n.isExpanded===void 0?!0:!!n.isExpanded))return!1;t=n.children}return!0},emitInput(e){this.currentValue=e,this.getRoot().$emit("update:modelValue",e)},emitSelect(e,t){this.getRoot().$emit("select",e,t)},emitBeforeDrop(e,t,o){this.getRoot().$emit("beforedrop",e,t,o)},emitDrop(e,t,o){this.getRoot().$emit("drop",e,t,o)},emitToggle(e,t){this.getRoot().$emit("toggle",e,t)},emitNodeClick(e,t){this.getRoot().$emit("nodeclick",e,t)},emitNodeDblclick(e,t){this.getRoot().$emit("nodedblclick",e,t)},emitNodeContextmenu(e,t){this.getRoot().$emit("nodecontextmenu",e,t)},onExternalDragoverHandler(e,t){t.preventDefault();const o=this.getRoot(),r=o.getCursorPositionFromCoords(t.clientX,t.clientY);o.setCursorPosition(r),o.$emit("externaldragover",r,t)},onExternalDropHandler(e,t){const o=this.getRoot(),r=o.getCursorPositionFromCoords(t.clientX,t.clientY);o.$emit("externaldrop",r,t),this.setCursorPosition(null)},select(e,t=!1,o=null){const r=this.getNode(e);if(!r)return null;const l=o&&!!["ctrlKey","metaKey"].find(h=>o[h])&&this.allowMultiselect,i=o&&o.shiftKey&&this.allowMultiselect&&this.lastSelectedNode;t=(l||t)&&this.allowMultiselect;const d=this.currentValue,a=[];let p=!1;return this.traverse((h,u)=>{i?((h.pathStr===r.pathStr||h.pathStr===this.lastSelectedNode.pathStr)&&(u.isSelected=h.isSelectable,p=!p),p&&(u.isSelected=h.isSelectable)):h.pathStr===r.pathStr?u.isSelected=u.isSelected?!1:h.isSelectable:t||u.isSelected&&(u.isSelected=!1),u.isSelected&&a.push(u)},d),this.lastSelectedNode=r,this.emitInput(d),this.emitSelect(a,o),r},onMousemoveHandler(e){if(!this.isRoot){this.getRoot().onMousemoveHandler(e);return}if(this.preventDrag)return;const t=this.isDragging,o=this.isDragging||this.mouseIsDown&&(this.lastMousePos.x!==e.clientX||this.lastMousePos.y!==e.clientY),r=t===!1&&o===!0;if(this.lastMousePos={x:e.clientX,y:e.clientY},!o)return;const n=this.getRoot().$el,l=n.getBoundingClientRect(),c=this.$refs.dragInfo,i=e.clientY-l.top+n.scrollTop-(c.style.marginBottom|0),d=e.clientX-l.left;c.style.top=i+"px",c.style.left=d+"px";const a=this.getCursorPositionFromCoords(e.clientX,e.clientY),p=a.node,h=a.placement;if(r&&!p.isSelected&&this.select(p.path,!1,e),!this.getDraggable().length){this.preventDrag=!0;return}this.isDragging=o,this.setCursorPosition({node:p,placement:h});const f=l.bottom-this.scrollAreaHeight,m=(e.clientY-f)/(l.bottom-f),S=l.top+this.scrollAreaHeight,N=(S-e.clientY)/(S-l.top);m>0?this.startScroll(m):N>0?this.startScroll(-N):this.stopScroll()},getCursorPositionFromCoords(e,t){const o=document.elementFromPoint(e,t),r=o.getAttribute("path")?o:this.getClosetElementWithPath(o);let n,l;if(r){if(!r)return;n=this.getNode(JSON.parse(r.getAttribute("path")));const c=r.offsetHeight,i=this.edgeSize,d=t-r.getBoundingClientRect().top;n.isLeaf?l=d>=c/2?"after":"before":d<=i?l="before":d>=c-i?l="after":l="inside"}else{const i=this.getRoot().$el.getBoundingClientRect();t>i.top+i.height/2?(l="after",n=this.getLastNode()):(l="before",n=this.getFirstNode())}return{node:n,placement:l}},getClosetElementWithPath(e){return e?e.getAttribute("path")?e:this.getClosetElementWithPath(e.parentElement):null},onMouseleaveHandler(e){if(!this.isRoot||!this.isDragging)return;const o=this.getRoot().$el.getBoundingClientRect();e.clientY>=o.bottom?this.setCursorPosition({node:this.nodes.slice(-1)[0],placement:"after"}):e.clientY<o.top&&this.setCursorPosition({node:this.getFirstNode(),placement:"before"})},getNodeEl(e){this.getRoot().$el.querySelector(`[path="${JSON.stringify(e)}"]`)},getLastNode(){let e=null;return this.traverse(t=>{e=t}),e},getFirstNode(){return this.getNode([0])},getNextNode(e,t=null){let o=null;return this.traverse(r=>{if(!(this.comparePaths(r.path,e)<1)&&(!t||t(r)))return o=r,!1}),o},getPrevNode(e,t){let o=[];this.traverse(n=>{if(this.comparePaths(n.path,e)>=0)return!1;o.push(n)});let r=o.length;for(;r--;){const n=o[r];if(!t||t(n))return n}return null},comparePaths(e,t){for(let o=0;o<e.length;o++){if(t[o]===void 0||e[o]>t[o])return 1;if(e[o]<t[o])return-1}return t[e.length]===void 0?0:-1},onNodeMousedownHandler(e,t){if(e.button===0){if(!this.isRoot){this.getRoot().onNodeMousedownHandler(e,t);return}this.mouseIsDown=!0}},startScroll(e){const t=this.getRoot().$el;this.scrollSpeed!==e&&(this.scrollIntervalId&&this.stopScroll(),this.scrollSpeed=e,this.scrollIntervalId=setInterval(()=>{t.scrollTop+=this.maxScrollSpeed*e},20))},stopScroll(){clearInterval(this.scrollIntervalId),this.scrollIntervalId=0,this.scrollSpeed=0},onDocumentMouseupHandler(e){this.isDragging&&this.onNodeMouseupHandler(e)},onNodeMouseupHandler(e,t=null){if(e.button!==0)return;if(!this.isRoot){this.getRoot().onNodeMouseupHandler(e,t);return}if(this.mouseIsDown=!1,!this.isDragging&&t&&!this.preventDrag&&e.currentTarget.dataset.tree==="title"&&this.select(t.path,!1,e),this.preventDrag=!1,!this.cursorPosition){this.stopDrag();return}const o=this.getDraggable();for(let i of o){if(i.pathStr===this.cursorPosition.node.pathStr){this.stopDrag();return}if(this.checkNodeIsParent(i,this.cursorPosition.node)){this.stopDrag();return}}const r=this.copy(this.currentValue),n=[];for(let i of o){const a=this.getNodeSiblings(r,i.path)[i.ind];n.push(a)}let l=!1;if(this.emitBeforeDrop(o,this.cursorPosition,()=>l=!0),l){this.stopDrag();return}const c=[];for(let i of n)c.push(this.copy(i)),i._markToDelete=!0;this.insertModels(this.cursorPosition,c,r),this.traverseModels((i,d,a)=>{i._markToDelete&&d.splice(a,1)},r),this.lastSelectedNode=null,this.emitInput(r),this.emitDrop(o,this.cursorPosition,e),this.stopDrag()},onToggleHandler(e,t){this.allowToggleBranch&&(this.updateNode(t.path,{isExpanded:!t.isExpanded}),this.emitToggle(t,e),e.stopPropagation())},stopDrag(){this.isDragging=!1,this.mouseIsDown=!1,this.setCursorPosition(null),this.stopScroll()},getParent(){return this.$parent},getRoot(){return this.isRoot?this:this.getParent().getRoot()},getNodeSiblings(e,t){return t.length===1?e:this.getNodeSiblings(e[t[0]].children,t.slice(1))},updateNode(e,t){if(!this.isRoot){this.getParent().updateNode(e,t);return}const o=JSON.stringify(e),r=this.copy(this.currentValue);this.traverse((n,l)=>{n.pathStr===o&&Object.assign(l,t)},r),this.emitInput(r)},getSelected(){const e=[];return this.traverse(t=>{t.isSelected&&e.push(t)}),e},getDraggable(){const e=[];return this.traverse(t=>{t.isSelected&&t.isDraggable&&e.push(t)}),e},traverse(e,t=null,o=[]){t||(t=this.currentValue);let r=!1;const n=[];for(let l=0;l<t.length;l++){const c=t[l],i=o.concat(l),d=this.getNode(i,c,t);if(r=e(d,c,t)===!1,n.push(d),r||c.children&&(r=this.traverse(e,c.children,i)===!1,r))break}return r?!1:n},traverseModels(e,t){let o=t.length;for(;o--;){const r=t[o];r.children&&this.traverseModels(e,r.children),e(r,t,o)}return t},remove(e){const t=e.map(r=>JSON.stringify(r)),o=this.copy(this.currentValue);this.traverse((r,n,l)=>{for(const c of t)r.pathStr===c&&(n._markToDelete=!0)},o),this.traverseModels((r,n,l)=>{r._markToDelete&&n.splice(l,1)},o),this.emitInput(o)},insertModels(e,t,o){const r=e.node,n=this.getNodeSiblings(o,r.path),l=n[r.ind];if(e.placement==="inside")l.children=l.children||[],l.children.unshift(...t);else{const c=e.placement==="before"?r.ind:r.ind+1;n.splice(c,0,...t)}},insert(e,t){const o=Array.isArray(t)?t:[t],r=this.copy(this.currentValue);this.insertModels(e,o,r),this.emitInput(r)},checkNodeIsParent(e,t){const o=t.path;return JSON.stringify(o.slice(0,e.path.length))===e.pathStr},copy(e){return JSON.parse(JSON.stringify(e))}}},w=(e,t)=>{const o=e.__vccOpts||e;for(const[r,n]of t)o[r]=n;return o},y={ref:"nodes",class:"vue-power-tree-nodes-list"},b=["path"],C={class:"vue-power-tree-gap"},P={key:0,class:"vue-power-tree-branch"},k={key:0},B={key:1},E={class:"vue-power-tree-row","data-tree":"row"},I=["onClick"],R=["onMousedown","onMouseup","onContextmenu","onDblclick","onClick","onDragover","onDrop"],V={class:"vue-power-tree-sidebar","data-tree":"sidebar"},$={key:0,ref:"dragInfo",class:"vue-power-tree-drag-info"};function H(e,t,o,r,n,l){const c=s.resolveComponent("power-tree",!0);return s.openBlock(),s.createElementBlock("div",{class:s.normalizeClass(["vue-power-tree",{"vue-power-tree-root":e.isRoot}]),onMousemove:t[3]||(t[3]=(...i)=>e.onMousemoveHandler&&e.onMousemoveHandler(...i)),onMouseleave:t[4]||(t[4]=(...i)=>e.onMouseleaveHandler&&e.onMouseleaveHandler(...i)),onDragend:t[5]||(t[5]=i=>e.onDragendHandler(null,i))},[s.createElementVNode("div",y,[(s.openBlock(!0),s.createElementBlock(s.Fragment,null,s.renderList(e.nodes,(i,d)=>(s.openBlock(),s.createElementBlock("div",{class:s.normalizeClass(["vue-power-tree-node",{"vue-power-tree-selected":i.isSelected}])},[s.createElementVNode("div",{class:"vue-power-tree-cursor vue-power-tree-cursor_before",onDragover:t[0]||(t[0]=s.withModifiers(()=>{},["prevent"])),style:s.normalizeStyle({visibility:e.cursorPosition&&e.cursorPosition.node.pathStr===i.pathStr&&e.cursorPosition.placement==="before"?"visible":"hidden","--depth":e.depth})},null,36),s.createElementVNode("div",{class:s.normalizeClass(["vue-power-tree-node-item",{"vue-power-tree-cursor-hover":e.cursorPosition&&e.cursorPosition.node.pathStr===i.pathStr,"vue-power-tree-cursor-inside":e.cursorPosition&&e.cursorPosition.placement==="inside"&&e.cursorPosition.node.pathStr===i.pathStr,"vue-power-tree-node-is-leaf":i.isLeaf,"vue-power-tree-node-is-folder":!i.isLeaf}]),path:i.pathStr},[(s.openBlock(!0),s.createElementBlock(s.Fragment,null,s.renderList(e.gaps,a=>(s.openBlock(),s.createElementBlock("div",C))),256)),e.level&&e.showBranches?(s.openBlock(),s.createElementBlock("div",P,[s.renderSlot(e.$slots,"branch",{node:i},()=>[i.isLastChild?s.createCommentVNode("",!0):(s.openBlock(),s.createElementBlock("span",k,s.toDisplayString("├")+s.toDisplayString("─")+"  ",1)),i.isLastChild?(s.openBlock(),s.createElementBlock("span",B,s.toDisplayString("└")+s.toDisplayString("─")+"  ",1)):s.createCommentVNode("",!0)])])):s.createCommentVNode("",!0),s.createElementVNode("div",E,[i.isLeaf?s.createCommentVNode("",!0):(s.openBlock(),s.createElementBlock("span",{key:0,class:"vue-power-tree-toggle",onClick:a=>e.onToggleHandler(a,i)},[s.renderSlot(e.$slots,"toggle",{node:i},()=>[s.createElementVNode("span",null,s.toDisplayString(i.isLeaf?"":i.isExpanded?"-":"+"),1)])],8,I)),s.createElementVNode("span",{onMousedown:a=>e.onNodeMousedownHandler(a,i),onMouseup:a=>e.onNodeMouseupHandler(a,i),onContextmenu:a=>e.emitNodeContextmenu(i,a),onDblclick:a=>e.emitNodeDblclick(i,a),onClick:a=>e.emitNodeClick(i,a),onDragover:a=>e.onExternalDragoverHandler(i,a),onDrop:a=>e.onExternalDropHandler(i,a),"data-tree":"title",class:"vue-power-tree-title"},[s.renderSlot(e.$slots,"title",{node:i},()=>[s.createTextVNode(s.toDisplayString(i.title),1)])],40,R),!i.isLeaf&&i.children.length==0&&i.isExpanded?s.renderSlot(e.$slots,"empty-node",{key:1,node:i}):s.createCommentVNode("",!0)]),s.createElementVNode("div",V,[s.renderSlot(e.$slots,"sidebar",{node:i})])],10,b),i.children&&i.children.length&&i.isExpanded?(s.openBlock(),s.createBlock(c,{key:0,value:i.children,level:i.level,parentInd:d,allowMultiselect:e.allowMultiselect,allowToggleBranch:e.allowToggleBranch,edgeSize:e.edgeSize,showBranches:e.showBranches,onDragover:t[1]||(t[1]=s.withModifiers(()=>{},["prevent"]))},{title:s.withCtx(({node:a})=>[s.renderSlot(e.$slots,"title",{node:a},()=>[s.createTextVNode(s.toDisplayString(a.title),1)])]),toggle:s.withCtx(({node:a})=>[s.renderSlot(e.$slots,"toggle",{node:a},()=>[s.createElementVNode("span",null,s.toDisplayString(a.isLeaf?"":a.isExpanded?"-":"+"),1)])]),sidebar:s.withCtx(({node:a})=>[s.renderSlot(e.$slots,"sidebar",{node:a})]),"empty-node":s.withCtx(({node:a})=>[!a.isLeaf&&a.children.length===0&&a.isExpanded?s.renderSlot(e.$slots,"empty-node",{key:0,node:a}):s.createCommentVNode("",!0)]),_:2},1032,["value","level","parentInd","allowMultiselect","allowToggleBranch","edgeSize","showBranches"])):s.createCommentVNode("",!0),s.createElementVNode("div",{class:"vue-power-tree-cursor vue-power-tree-cursor_after",onDragover:t[2]||(t[2]=s.withModifiers(()=>{},["prevent"])),style:s.normalizeStyle({visibility:e.cursorPosition&&e.cursorPosition.node.pathStr===i.pathStr&&e.cursorPosition.placement==="after"?"visible":"hidden","--depth":e.depth})},null,36)],2))),256)),e.isRoot?s.withDirectives((s.openBlock(),s.createElementBlock("div",$,[s.renderSlot(e.$slots,"draginfo",{},()=>[s.createTextVNode(" Items: "+s.toDisplayString(e.selectionSize),1)])],512)),[[s.vShow,e.isDragging]]):s.createCommentVNode("",!0)],512)],34)}const T=w(D,[["render",H]]);g.PowerTree=T,Object.defineProperty(g,Symbol.toStringTag,{value:"Module"})});
