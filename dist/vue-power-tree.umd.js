(function(u,s){typeof exports=="object"&&typeof module!="undefined"?s(exports,require("vue")):typeof define=="function"&&define.amd?define(["exports","vue"],s):(u=typeof globalThis!="undefined"?globalThis:u||self,s(u.VuePowerTree={},u.Vue))})(this,function(u,s){"use strict";var N={name:"power-tree",emits:["update:modelValue","select","beforedrop","drop","toggle","nodeclick","nodedblclick","nodecontextmenu","externaldragover","externaldrop"],props:{modelValue:{type:Array,default:()=>[]},edgeSize:{type:Number,default:3},showBranches:{type:Boolean,default:!1},level:{type:Number,default:0},parentInd:{type:Number},allowMultiselect:{type:Boolean,default:!0},allowToggleBranch:{type:Boolean,default:!0},multiselectKey:{type:[String,Array],default:function(){return["ctrlKey","metaKey"]},validator:function(e){let t=["ctrlKey","metaKey","altKey"],r=Array.isArray(e)?e:[e];return r=r.filter(i=>t.indexOf(i)!==-1),!!r.length}},scrollAreaHeight:{type:Number,default:70},maxScrollSpeed:{type:Number,default:20}},data(){return{rootCursorPosition:null,scrollIntervalId:0,scrollSpeed:0,lastSelectedNode:null,mouseIsDown:!1,isDragging:!1,lastMousePos:{x:0,y:0},preventDrag:!1,currentValue:this.modelValue}},mounted(){this.isRoot&&document.addEventListener("mouseup",this.onDocumentMouseupHandler)},beforeDestroy(){document.removeEventListener("mouseup",this.onDocumentMouseupHandler)},watch:{modelValue:function(e){this.currentValue=this.copy(e)}},computed:{cursorPosition(){return this.isRoot?this.rootCursorPosition:this.getParent().cursorPosition},depth(){return this.gaps.length},nodes(){if(this.isRoot){const e=this.copy(this.currentValue);return this.getNodes(e)}return this.getParent().nodes[this.parentInd].children},gaps(){const e=[];let t=this.level-1;for(this.showBranches||t++;t-- >0;)e.push(t);return e},isRoot(){return!this.level},selectionSize(){return this.getSelected().length},dragSize(){return this.getDraggable().length}},methods:{setCursorPosition(e){if(this.isRoot){this.rootCursorPosition=e;return}this.getParent().setCursorPosition(e)},getNodes(e,t=[],r=!0){return e.map((i,l)=>{const n=t.concat(l);return this.getNode(n,i,e,r)})},getNode(e,t=null,r=null,i=null){const l=e.slice(-1)[0];if(r=r||this.getNodeSiblings(this.currentValue,e),t=t||r&&r[l]||null,i==null&&(i=this.isVisible(e)),!t)return null;const n=t.isExpanded===void 0?!0:!!t.isExpanded,c=t.isDraggable===void 0?!0:!!t.isDraggable,o=t.isSelectable===void 0?!0:!!t.isSelectable;return{title:t.title,isLeaf:!!t.isLeaf,children:t.children?this.getNodes(t.children,e,n):[],isSelected:!!t.isSelected,isExpanded:n,isVisible:i,isDraggable:c,isSelectable:o,data:t.data!==void 0?t.data:{},path:e,pathStr:JSON.stringify(e),level:e.length,ind:l,isFirstChild:l===0,isLastChild:l===r.length-1}},isVisible(e){if(e.length<2)return!0;let t=this.currentValue;for(let r=0;r<e.length-1;r++){let i=e[r],l=t[i];if(!(l.isExpanded===void 0?!0:!!l.isExpanded))return!1;t=l.children}return!0},emitInput(e){this.currentValue=e,this.getRoot().$emit("update:modelValue",e)},emitSelect(e,t){this.getRoot().$emit("select",e,t)},emitBeforeDrop(e,t,r){this.getRoot().$emit("beforedrop",e,t,r)},emitDrop(e,t,r){this.getRoot().$emit("drop",e,t,r)},emitToggle(e,t){this.getRoot().$emit("toggle",e,t)},emitNodeClick(e,t){this.getRoot().$emit("nodeclick",e,t)},emitNodeDblclick(e,t){this.getRoot().$emit("nodedblclick",e,t)},emitNodeContextmenu(e,t){this.getRoot().$emit("nodecontextmenu",e,t)},onExternalDragoverHandler(e,t){t.preventDefault();const r=this.getRoot(),i=r.getCursorPositionFromCoords(t.clientX,t.clientY);r.setCursorPosition(i),r.$emit("externaldragover",i,t)},onExternalDropHandler(e,t){const r=this.getRoot(),i=r.getCursorPositionFromCoords(t.clientX,t.clientY);r.$emit("externaldrop",i,t),this.setCursorPosition(null)},select(e,t=!1,r=null){const i=Array.isArray(this.multiselectKey)?this.multiselectKey:[this.multiselectKey];t=(r&&!!i.find(h=>r[h])||t)&&this.allowMultiselect;const n=this.getNode(e);if(!n)return null;const c=this.copy(this.currentValue),o=this.allowMultiselect&&r&&r.shiftKey&&this.lastSelectedNode,d=[];let a=!1;return this.traverse((h,g)=>{o?((h.pathStr===n.pathStr||h.pathStr===this.lastSelectedNode.pathStr)&&(g.isSelected=h.isSelectable,a=!a),a&&(g.isSelected=h.isSelectable)):h.pathStr===n.pathStr?g.isSelected=h.isSelectable:t||g.isSelected&&(g.isSelected=!1),g.isSelected&&d.push(h)},c),this.lastSelectedNode=n,this.emitInput(c),this.emitSelect(d,r),n},onMousemoveHandler(e){if(!this.isRoot){this.getRoot().onMousemoveHandler(e);return}if(this.preventDrag)return;const t=this.isDragging,r=this.isDragging||this.mouseIsDown&&(this.lastMousePos.x!==e.clientX||this.lastMousePos.y!==e.clientY),i=t===!1&&r===!0;if(this.lastMousePos={x:e.clientX,y:e.clientY},!r)return;const l=this.getRoot().$el,n=l.getBoundingClientRect(),c=this.$refs.dragInfo,o=e.clientY-n.top+l.scrollTop-(c.style.marginBottom|0),d=e.clientX-n.left;c.style.top=o+"px",c.style.left=d+"px";const a=this.getCursorPositionFromCoords(e.clientX,e.clientY),h=a.node,g=a.placement;if(i&&!h.isSelected&&this.select(h.path,!1,e),!this.getDraggable().length){this.preventDrag=!0;return}this.isDragging=r,this.setCursorPosition({node:h,placement:g});const p=n.bottom-this.scrollAreaHeight,f=(e.clientY-p)/(n.bottom-p),m=n.top+this.scrollAreaHeight,S=(m-e.clientY)/(m-n.top);f>0?this.startScroll(f):S>0?this.startScroll(-S):this.stopScroll()},getCursorPositionFromCoords(e,t){const r=document.elementFromPoint(e,t),i=r.getAttribute("path")?r:this.getClosetElementWithPath(r);let l,n;if(i){if(!i)return;l=this.getNode(JSON.parse(i.getAttribute("path")));const c=i.offsetHeight,o=this.edgeSize,d=t-i.getBoundingClientRect().top;l.isLeaf?n=d>=c/2?"after":"before":d<=o?n="before":d>=c-o?n="after":n="inside"}else{const o=this.getRoot().$el.getBoundingClientRect();t>o.top+o.height/2?(n="after",l=this.getLastNode()):(n="before",l=this.getFirstNode())}return{node:l,placement:n}},getClosetElementWithPath(e){return e?e.getAttribute("path")?e:this.getClosetElementWithPath(e.parentElement):null},onMouseleaveHandler(e){if(!this.isRoot||!this.isDragging)return;const r=this.getRoot().$el.getBoundingClientRect();e.clientY>=r.bottom?this.setCursorPosition({node:this.nodes.slice(-1)[0],placement:"after"}):e.clientY<r.top&&this.setCursorPosition({node:this.getFirstNode(),placement:"before"})},getNodeEl(e){this.getRoot().$el.querySelector(`[path="${JSON.stringify(e)}"]`)},getLastNode(){let e=null;return this.traverse(t=>{e=t}),e},getFirstNode(){return this.getNode([0])},getNextNode(e,t=null){let r=null;return this.traverse(i=>{if(!(this.comparePaths(i.path,e)<1)&&(!t||t(i)))return r=i,!1}),r},getPrevNode(e,t){let r=[];this.traverse(l=>{if(this.comparePaths(l.path,e)>=0)return!1;r.push(l)});let i=r.length;for(;i--;){const l=r[i];if(!t||t(l))return l}return null},comparePaths(e,t){for(let r=0;r<e.length;r++){if(t[r]===void 0||e[r]>t[r])return 1;if(e[r]<t[r])return-1}return t[e.length]===void 0?0:-1},onNodeMousedownHandler(e,t){if(e.button===0){if(!this.isRoot){this.getRoot().onNodeMousedownHandler(e,t);return}this.mouseIsDown=!0}},startScroll(e){const t=this.getRoot().$el;this.scrollSpeed!==e&&(this.scrollIntervalId&&this.stopScroll(),this.scrollSpeed=e,this.scrollIntervalId=setInterval(()=>{t.scrollTop+=this.maxScrollSpeed*e},20))},stopScroll(){clearInterval(this.scrollIntervalId),this.scrollIntervalId=0,this.scrollSpeed=0},onDocumentMouseupHandler(e){this.isDragging&&this.onNodeMouseupHandler(e)},onNodeMouseupHandler(e,t=null){if(e.button!==0)return;if(!this.isRoot){this.getRoot().onNodeMouseupHandler(e,t);return}if(this.mouseIsDown=!1,!this.isDragging&&t&&!this.preventDrag&&e.currentTarget.dataset.tree==="title"&&this.select(t.path,!1,e),this.preventDrag=!1,!this.cursorPosition){this.stopDrag();return}const r=this.getDraggable();for(let o of r){if(o.pathStr===this.cursorPosition.node.pathStr){this.stopDrag();return}if(this.checkNodeIsParent(o,this.cursorPosition.node)){this.stopDrag();return}}const i=this.copy(this.currentValue),l=[];for(let o of r){const a=this.getNodeSiblings(i,o.path)[o.ind];l.push(a)}let n=!1;if(this.emitBeforeDrop(r,this.cursorPosition,()=>n=!0),n){this.stopDrag();return}const c=[];for(let o of l)c.push(this.copy(o)),o._markToDelete=!0;this.insertModels(this.cursorPosition,c,i),this.traverseModels((o,d,a)=>{!o._markToDelete||d.splice(a,1)},i),this.lastSelectedNode=null,this.emitInput(i),this.emitDrop(r,this.cursorPosition,e),this.stopDrag()},onToggleHandler(e,t){!this.allowToggleBranch||(this.updateNode(t.path,{isExpanded:!t.isExpanded}),this.emitToggle(t,e),e.stopPropagation())},stopDrag(){this.isDragging=!1,this.mouseIsDown=!1,this.setCursorPosition(null),this.stopScroll()},getParent(){return this.$parent},getRoot(){return this.isRoot?this:this.getParent().getRoot()},getNodeSiblings(e,t){return t.length===1?e:this.getNodeSiblings(e[t[0]].children,t.slice(1))},updateNode(e,t){if(!this.isRoot){this.getParent().updateNode(e,t);return}const r=JSON.stringify(e),i=this.copy(this.currentValue);this.traverse((l,n)=>{l.pathStr===r&&Object.assign(n,t)},i),this.emitInput(i)},getSelected(){const e=[];return this.traverse(t=>{t.isSelected&&e.push(t)}),e},getDraggable(){const e=[];return this.traverse(t=>{t.isSelected&&t.isDraggable&&e.push(t)}),e},traverse(e,t=null,r=[]){t||(t=this.currentValue);let i=!1;const l=[];for(let n=0;n<t.length;n++){const c=t[n],o=r.concat(n),d=this.getNode(o,c,t);if(i=e(d,c,t)===!1,l.push(d),i||c.children&&(i=this.traverse(e,c.children,o)===!1,i))break}return i?!1:l},traverseModels(e,t){let r=t.length;for(;r--;){const i=t[r];i.children&&this.traverseModels(e,i.children),e(i,t,r)}return t},remove(e){const t=e.map(i=>JSON.stringify(i)),r=this.copy(this.currentValue);this.traverse((i,l,n)=>{for(const c of t)i.pathStr===c&&(l._markToDelete=!0)},r),this.traverseModels((i,l,n)=>{!i._markToDelete||l.splice(n,1)},r),this.emitInput(r)},insertModels(e,t,r){const i=e.node,l=this.getNodeSiblings(r,i.path),n=l[i.ind];if(e.placement==="inside")n.children=n.children||[],n.children.unshift(...t);else{const c=e.placement==="before"?i.ind:i.ind+1;l.splice(c,0,...t)}},insert(e,t){const r=Array.isArray(t)?t:[t],i=this.copy(this.currentValue);this.insertModels(e,r,i),this.emitInput(i)},checkNodeIsParent(e,t){const r=t.path;return JSON.stringify(r.slice(0,e.path.length))===e.pathStr},copy(e){return JSON.parse(JSON.stringify(e))}}},y=(e,t)=>{const r=e.__vccOpts||e;for(const[i,l]of t)r[i]=l;return r};const D={ref:"nodes",class:"vue-power-tree-nodes-list"},w=["path"],b={class:"vue-power-tree-gap"},C={key:0,class:"vue-power-tree-branch"},P={key:0},k={key:1},B={class:"vue-power-tree-row","data-tree":"row"},E=["onClick"],I=["onMousedown","onMouseup","onContextmenu","onDblclick","onClick","onDragover","onDrop"],R={class:"vue-power-tree-sidebar","data-tree":"sidebar"},V={key:0,ref:"dragInfo",class:"vue-power-tree-drag-info"};function $(e,t,r,i,l,n){const c=s.resolveComponent("power-tree",!0);return s.openBlock(),s.createElementBlock("div",{class:s.normalizeClass(["vue-power-tree",{"vue-power-tree-root":e.isRoot}]),onMousemove:t[3]||(t[3]=(...o)=>e.onMousemoveHandler&&e.onMousemoveHandler(...o)),onMouseleave:t[4]||(t[4]=(...o)=>e.onMouseleaveHandler&&e.onMouseleaveHandler(...o)),onDragend:t[5]||(t[5]=o=>e.onDragendHandler(null,o))},[s.createElementVNode("div",D,[(s.openBlock(!0),s.createElementBlock(s.Fragment,null,s.renderList(e.nodes,(o,d)=>(s.openBlock(),s.createElementBlock("div",{class:s.normalizeClass(["vue-power-tree-node",{"vue-power-tree-selected":o.isSelected}])},[s.createElementVNode("div",{class:"vue-power-tree-cursor vue-power-tree-cursor_before",onDragover:t[0]||(t[0]=s.withModifiers(()=>{},["prevent"])),style:s.normalizeStyle({visibility:e.cursorPosition&&e.cursorPosition.node.pathStr===o.pathStr&&e.cursorPosition.placement==="before"?"visible":"hidden","--depth":e.depth})},null,36),s.createElementVNode("div",{class:s.normalizeClass(["vue-power-tree-node-item",{"vue-power-tree-cursor-hover":e.cursorPosition&&e.cursorPosition.node.pathStr===o.pathStr,"vue-power-tree-cursor-inside":e.cursorPosition&&e.cursorPosition.placement==="inside"&&e.cursorPosition.node.pathStr===o.pathStr,"vue-power-tree-node-is-leaf":o.isLeaf,"vue-power-tree-node-is-folder":!o.isLeaf}]),path:o.pathStr},[(s.openBlock(!0),s.createElementBlock(s.Fragment,null,s.renderList(e.gaps,a=>(s.openBlock(),s.createElementBlock("div",b))),256)),e.level&&e.showBranches?(s.openBlock(),s.createElementBlock("div",C,[s.renderSlot(e.$slots,"branch",{node:o},()=>[o.isLastChild?s.createCommentVNode("",!0):(s.openBlock(),s.createElementBlock("span",P,s.toDisplayString(String.fromCharCode(9500))+s.toDisplayString(String.fromCharCode(9472))+"\xA0 ",1)),o.isLastChild?(s.openBlock(),s.createElementBlock("span",k,s.toDisplayString(String.fromCharCode(9492))+s.toDisplayString(String.fromCharCode(9472))+"\xA0 ",1)):s.createCommentVNode("",!0)])])):s.createCommentVNode("",!0),s.createElementVNode("div",B,[o.isLeaf?s.createCommentVNode("",!0):(s.openBlock(),s.createElementBlock("span",{key:0,class:"vue-power-tree-toggle",onClick:a=>e.onToggleHandler(a,o)},[s.renderSlot(e.$slots,"toggle",{node:o},()=>[s.createElementVNode("span",null,s.toDisplayString(o.isLeaf?"":o.isExpanded?"-":"+"),1)])],8,E)),s.createElementVNode("span",{onMousedown:a=>e.onNodeMousedownHandler(a,o),onMouseup:a=>e.onNodeMouseupHandler(a,o),onContextmenu:a=>e.emitNodeContextmenu(o,a),onDblclick:a=>e.emitNodeDblclick(o,a),onClick:a=>e.emitNodeClick(o,a),onDragover:a=>e.onExternalDragoverHandler(o,a),onDrop:a=>e.onExternalDropHandler(o,a),"data-tree":"title",class:"vue-power-tree-title"},[s.renderSlot(e.$slots,"title",{node:o},()=>[s.createTextVNode(s.toDisplayString(o.title),1)])],40,I),!o.isLeaf&&o.children.length==0&&o.isExpanded?s.renderSlot(e.$slots,"empty-node",{key:1,node:o}):s.createCommentVNode("",!0)]),s.createElementVNode("div",R,[s.renderSlot(e.$slots,"sidebar",{node:o})])],10,w),o.children&&o.children.length&&o.isExpanded?(s.openBlock(),s.createBlock(c,{key:0,value:o.children,level:o.level,parentInd:d,allowMultiselect:e.allowMultiselect,allowToggleBranch:e.allowToggleBranch,edgeSize:e.edgeSize,showBranches:e.showBranches,onDragover:t[1]||(t[1]=s.withModifiers(()=>{},["prevent"]))},{title:s.withCtx(({node:a})=>[s.renderSlot(e.$slots,"title",{node:a},()=>[s.createTextVNode(s.toDisplayString(a.title),1)])]),toggle:s.withCtx(({node:a})=>[s.renderSlot(e.$slots,"toggle",{node:a},()=>[s.createElementVNode("span",null,s.toDisplayString(a.isLeaf?"":a.isExpanded?"-":"+"),1)])]),sidebar:s.withCtx(({node:a})=>[s.renderSlot(e.$slots,"sidebar",{node:a})]),"empty-node":s.withCtx(({node:a})=>[!a.isLeaf&&a.children.length===0&&a.isExpanded?s.renderSlot(e.$slots,"empty-node",{key:0,node:a}):s.createCommentVNode("",!0)]),_:2},1032,["value","level","parentInd","allowMultiselect","allowToggleBranch","edgeSize","showBranches"])):s.createCommentVNode("",!0),s.createElementVNode("div",{class:"vue-power-tree-cursor vue-power-tree-cursor_after",onDragover:t[2]||(t[2]=s.withModifiers(()=>{},["prevent"])),style:s.normalizeStyle({visibility:e.cursorPosition&&e.cursorPosition.node.pathStr===o.pathStr&&e.cursorPosition.placement==="after"?"visible":"hidden","--depth":e.depth})},null,36)],2))),256)),e.isRoot?s.withDirectives((s.openBlock(),s.createElementBlock("div",V,[s.renderSlot(e.$slots,"draginfo",{},()=>[s.createTextVNode(" Items: "+s.toDisplayString(e.selectionSize),1)])],512)),[[s.vShow,e.isDragging]]):s.createCommentVNode("",!0)],512)],34)}var H=y(N,[["render",$]]),T="";u.PowerTree=H,Object.defineProperty(u,"__esModule",{value:!0}),u[Symbol.toStringTag]="Module"});
